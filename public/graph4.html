<!DOCTYPE html>

<head>
    <style>
        /* set the CSS */
        
        body {
            font: 12px Arial;
        }
        
        path {
            stroke: steelblue;
            stroke-width: 2;
            fill: none;
        }
        
        line {
            stroke: gray;
        }
        
        .axis path,
        .axis line {
            fill: none;
            stroke: blue;
            stroke-width: 2;
            shape-rendering: crispEdges;
        }
    </style>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.5.2/css/bulma.min.css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="chart.js"></script>
</head>


<body>
    <div class="hero-body">
        <div class="container has-text-centered">
            <div id="chart">
                <svg class="is-fullwidth is-large"></svg>
            </div>
        </div>
        <ul id="messages"></ul>
        <form action="">
            <div class="field has-addons">
                <input id="m" autocomplete="off" /><button class="button is-success">Send</button>
            </div>
        </form>

        <script defer>
            $(function() {
                var socket = io();

                let sizes = {
                    margin: {
                        top: 30,
                        right: 20,
                        bottom: 30,
                        left: 50
                    },
                    width: 1000,
                    height: 500
                };

                // initial load
                d3.json("/stocks", function(error, data) {
                    if (error) {
                        throw error
                    } else {
                        let chart = buildGraph(sizes, data);

                        data.forEach(function(symbolData) {
                            addSymbolToInterface(symbolData.key);
                        });


                        $('form').submit(function() {

                            socket.emit('addSymbol', $('#m').val());
                            $('#m').val('');
                            return false;
                        });

                        function addSymbolToInterface(symbolKey) {
                            $('#messages').append($('<li id="item' + symbolKey + '">').text(symbolKey));
                            $('#item' + symbolKey).bind('click', function() {
                                socket.emit('removeSymbol', symbolKey);
                            });
                        }

                        socket.on('symbolAdded', function(symbolData) {
                            console.log(symbolData);
                            addSymbolToInterface(symbolData.key);
                            chart.addSymbol(symbolData);
                        });



                        socket.on('symbolRemoved', function(symbolKey) {
                            console.log('symbolRemoved' + symbolKey);
                            $('#item' + symbolKey).remove();
                            console.log('removed');
                            chart.removeSymbolByKey(symbolKey);
                        });

                    }
                });




            });
        </script>



</body>